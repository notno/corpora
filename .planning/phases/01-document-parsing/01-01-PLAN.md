---
phase: 01-document-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/corpora/__init__.py
  - src/corpora/__main__.py
  - src/corpora/models/__init__.py
  - src/corpora/models/output.py
  - src/corpora/utils/__init__.py
  - src/corpora/utils/normalization.py
  - src/corpora/utils/errors.py
autonomous: true

must_haves:
  truths:
    - "Project is installable via pip install -e ."
    - "python -m corpora runs without import errors"
    - "DocumentOutput model validates and serializes to JSON"
    - "Text normalization handles ligatures and encoding"
  artifacts:
    - path: "pyproject.toml"
      provides: "Package configuration with dependencies"
      contains: "pymupdf"
    - path: "src/corpora/models/output.py"
      provides: "Pydantic output schema"
      exports: ["DocumentOutput", "ContentBlock"]
    - path: "src/corpora/utils/normalization.py"
      provides: "Text normalization utilities"
      exports: ["normalize_text"]
    - path: "src/corpora/utils/errors.py"
      provides: "Custom exceptions and error logging"
      exports: ["ExtractionError", "log_error"]
  key_links:
    - from: "src/corpora/__main__.py"
      to: "src/corpora/cli/main.py"
      via: "import"
      pattern: "from corpora.cli"
---

<objective>
Set up the corpora Python package with project structure, Pydantic models for JSON output, and utility functions for text normalization and error handling.

Purpose: Establish the foundation that all parsers and CLI will build upon. This includes the output schema that Phase 2 will consume, and utilities that ensure consistent text processing across all document types.

Output: Installable Python package with models and utilities ready for parser implementation.
</objective>

<execution_context>
@C:\Users\nrosq\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\nrosq\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-document-parsing/01-CONTEXT.md
@.planning/phases/01-document-parsing/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and pyproject.toml</name>
  <files>
    pyproject.toml
    src/corpora/__init__.py
    src/corpora/__main__.py
    src/corpora/cli/__init__.py
    src/corpora/parsers/__init__.py
    src/corpora/models/__init__.py
    src/corpora/utils/__init__.py
  </files>
  <action>
Create the src-layout Python package structure per RESEARCH.md recommendations.

pyproject.toml must include:
- name: "corpora"
- version: "0.1.0"
- python_requires: ">=3.10" (PyMuPDF requirement)
- dependencies: pymupdf, typer[all], pydantic>=2.0, rich
- optional-dependencies.ocr: pytesseract
- project.scripts: corpora = "corpora.cli.main:app"

__main__.py should import and run the CLI app:
```python
from corpora.cli.main import app
app()
```

Create empty __init__.py files in all subdirectories.

Do NOT install the package yet - that happens after all files are created.
  </action>
  <verify>
All files exist with proper structure:
- ls src/corpora/cli/__init__.py
- ls src/corpora/parsers/__init__.py
- ls src/corpora/models/__init__.py
- ls src/corpora/utils/__init__.py
- grep "pymupdf" pyproject.toml
  </verify>
  <done>
Package structure exists matching RESEARCH.md layout. pyproject.toml defines all required dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pydantic output models</name>
  <files>
    src/corpora/models/__init__.py
    src/corpora/models/output.py
  </files>
  <action>
Create Pydantic v2 models matching the output schema from CONTEXT.md.

ContentBlock model:
- type: str (e.g., "text", "heading")
- text: str
- page: Optional[int] = None
- chapter: Optional[int] = None

DocumentOutput model:
- source: str (source file path)
- format: Literal["pdf", "epub"]
- extracted_at: datetime (default_factory=datetime.now)
- ocr_used: bool = False
- metadata: dict = Field(default_factory=dict)
- content: List[ContentBlock]
- Method: to_json_file(path: str) -> None

Use Pydantic v2 syntax:
- model_dump_json() not json()
- Field() for defaults
- ConfigDict for model config if needed

Export both models from models/__init__.py.
  </action>
  <verify>
```python
python -c "from corpora.models import DocumentOutput, ContentBlock; print('Models import OK')"
python -c "
from corpora.models import DocumentOutput, ContentBlock
doc = DocumentOutput(source='test.pdf', format='pdf', content=[ContentBlock(type='text', text='hello')])
print(doc.model_dump_json(indent=2))
"
```
  </verify>
  <done>
DocumentOutput and ContentBlock models validate correctly and serialize to JSON matching the schema in CONTEXT.md.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create utility modules (normalization + errors)</name>
  <files>
    src/corpora/utils/__init__.py
    src/corpora/utils/normalization.py
    src/corpora/utils/errors.py
  </files>
  <action>
Create normalization.py with normalize_text() function per RESEARCH.md:
- Apply NFKC Unicode normalization (decompose ligatures like "fi" -> "fi")
- Normalize line endings to \n
- Collapse multiple spaces to single (preserve newlines)
- Collapse 3+ newlines to max 2
- Strip whitespace from each line
- Return stripped result

Create errors.py with:
- ExtractionError(Exception) - base exception for extraction failures
- OCRRequiredError(ExtractionError) - when OCR is needed but unavailable
- log_error(error: Exception, source: str, log_path: str = "corpora-errors.log") -> None
  - Appends timestamped error entry to log file
  - Format: "[ISO timestamp] [source] ErrorType: message"

Export all from utils/__init__.py.

Install package after creating files:
```bash
pip install -e .
```
  </action>
  <verify>
```bash
pip install -e .
python -c "from corpora.utils import normalize_text, ExtractionError, log_error; print('Utils import OK')"
python -c "
from corpora.utils import normalize_text
text = 'Hello\r\n\r\n\r\nWorld   with   spaces'
result = normalize_text(text)
print(repr(result))
assert '\r' not in result
assert '   ' not in result
print('Normalization OK')
"
```
  </verify>
  <done>
normalize_text handles encoding normalization. ExtractionError hierarchy defined. log_error writes to corpora-errors.log. Package installs successfully.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pip install -e .` succeeds
2. `python -m corpora --help` shows CLI stub (may show "No commands" until Plan 03)
3. Models and utils importable from corpora package
4. All files exist in expected locations
</verification>

<success_criteria>
- Package structure matches RESEARCH.md layout
- pyproject.toml has all dependencies (pymupdf, typer, pydantic, rich)
- DocumentOutput serializes to JSON with schema from CONTEXT.md
- normalize_text correctly handles ligatures and whitespace
- Error utilities ready for parser use
</success_criteria>

<output>
After completion, create `.planning/phases/01-document-parsing/01-01-SUMMARY.md`
</output>
