---
phase: 03-output-ip-review
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - src/corpora/ip/reviewer.py
  - src/corpora/ip/__init__.py
  - src/corpora/cli/output.py
  - src/corpora/cli/main.py
  - tests/test_output.py
autonomous: true

must_haves:
  truths:
    - "User can generate flagged.json review queue from vocabulary"
    - "User can run 'corpora output' to generate .vocab.json from extract output"
    - "User can run 'corpora consolidate' to merge vocab files into master"
    - "Consolidation shows change summary (+new, ~updated, -removed)"
  artifacts:
    - path: "src/corpora/ip/reviewer.py"
      provides: "Review queue generation for IP-flagged terms"
      exports: ["FlaggedTerm", "ReviewQueue", "generate_review_queue"]
    - path: "src/corpora/cli/output.py"
      provides: "CLI commands for output and consolidate"
      exports: ["output_command", "consolidate_command"]
    - path: "tests/test_output.py"
      provides: "Tests for output module and CLI"
  key_links:
    - from: "src/corpora/cli/output.py"
      to: "src/corpora/output/vocab_writer.py"
      via: "uses write_vocab_file"
      pattern: "write_vocab_file"
    - from: "src/corpora/cli/output.py"
      to: "src/corpora/output/consolidator.py"
      via: "uses consolidate_vocabularies"
      pattern: "consolidate_vocabularies"
    - from: "src/corpora/cli/output.py"
      to: "src/corpora/ip/reviewer.py"
      via: "uses generate_review_queue"
      pattern: "generate_review_queue"
---

<objective>
Complete Phase 3 with review queue generation and CLI integration: 'corpora output' for per-document vocab files, 'corpora consolidate' for master vocabulary creation.

Purpose: This enables IP-03 (review queue output) and provides the CLI interface for the full output workflow.

Output: Review queue module, CLI commands, and comprehensive tests
</objective>

<execution_context>
@C:\Users\nrosq\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\nrosq\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output-ip-review/03-CONTEXT.md
@.planning/phases/03-output-ip-review/03-RESEARCH.md

# Prior plans in this phase
@.planning/phases/03-output-ip-review/03-01-SUMMARY.md
@.planning/phases/03-output-ip-review/03-02-SUMMARY.md
@.planning/phases/03-output-ip-review/03-03-SUMMARY.md

# CLI patterns from Phase 2
@src/corpora/cli/extract.py
@src/corpora/cli/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review queue generator for IP-flagged terms</name>
  <files>
    src/corpora/ip/reviewer.py
    src/corpora/ip/__init__.py
  </files>
  <action>
Create `reviewer.py` with models and functions for flagged.json:

1. `FlaggedTerm` model:
   - canonical: str
   - text: str
   - source: str
   - flag_reason: str
   - confidence: float
   - category: str
   - reviewed: bool = False
   - decision: str = "" (keep/remove/replace)
   - notes: str = ""

2. `ReviewQueue` model:
   - generated_at: datetime
   - total_flagged: int
   - reviewed_count: int = 0
   - terms: List[FlaggedTerm]
   - to_file(path: Path): Write to flagged.json with indent=2

3. `generate_review_queue(vocab: VocabularyOutput, output_path: Path) -> ReviewQueue`:
   - Filter entries with ip_flag set
   - Create FlaggedTerm for each
   - Sort by canonical
   - Write to flagged.json and return queue

Add FlaggedTerm, ReviewQueue, generate_review_queue to ip/__init__.py exports.
  </action>
  <verify>
python -c "
from pathlib import Path
from corpora.ip import generate_review_queue, ReviewQueue
from corpora.output import VocabularyOutput, VocabularyMetadata, VocabularyEntry

vocab = VocabularyOutput(
    metadata=VocabularyMetadata(source_path='test.pdf', source_hash='abc', term_count=2, classified_count=2, flagged_count=1),
    entries=[
        VocabularyEntry(
            id='1', text='Beholder', source='test', intent='creature',
            pos='noun', category='creature', canonical='beholder', mood='dark',
            confidence=0.9, ip_flag='blocklist:dnd'
        ),
        VocabularyEntry(
            id='2', text='Dragon', source='test', intent='creature',
            pos='noun', category='creature', canonical='dragon', mood='epic',
            confidence=0.95
        )
    ]
)

queue = generate_review_queue(vocab, Path('test_flagged.json'))
print(f'Queue: {queue.total_flagged} flagged terms')
Path('test_flagged.json').unlink()
"
  </verify>
  <done>
generate_review_queue creates flagged.json with IP-flagged terms for human review
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement CLI output and consolidate commands</name>
  <files>
    src/corpora/cli/output.py
    src/corpora/cli/main.py
  </files>
  <action>
Create `output.py` with Typer commands following patterns from extract.py:

1. `output_command(input_path, output_path, blocklist, verbose)`:
   - Load classified terms from JSON (Phase 2 extract output)
   - Load blocklist if provided (default: data/ip-blocklist.json)
   - Apply IP flagging with flag_terms
   - Generate .vocab.json with write_vocab_file
   - Generate flagged.json if any terms flagged
   - Show summary: X terms, Y flagged

2. `consolidate_command(vocab_dir, master_path, blocklist, force, remove_orphans, verbose)`:
   - Find all .vocab.json files in directory
   - Load manifest for incremental processing
   - Skip unchanged files unless --force
   - Call consolidate_vocabularies
   - Generate flagged.json from master
   - Update manifest
   - Show change summary

CLI options:
- output: `corpora output <input.json> [--output PATH] [--blocklist PATH] [-v]`
- consolidate: `corpora consolidate <vocab_dir> [--master PATH] [--blocklist PATH] [--force] [--remove-orphans] [-v]`

Default output location: same directory as input with .vocab.json extension
Default master location: vocab_dir/master.vocab.json

Use Rich console for formatted output. Follow exit code patterns from parse.py.

Update main.py to register output_command and consolidate_command.
  </action>
  <verify>
corpora output --help
corpora consolidate --help
  </verify>
  <done>
'corpora output' generates .vocab.json + flagged.json from extract output; 'corpora consolidate' merges into master with change summary
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for output module and CLI</name>
  <files>
    tests/test_output.py
  </files>
  <action>
Create `test_output.py` with comprehensive tests:

**Model Tests:**
- test_vocabulary_output_serialization
- test_vocabulary_entry_with_ip_flag
- test_manifest_needs_processing
- test_manifest_orphan_detection

**Writer Tests:**
- test_write_vocab_file_creates_json
- test_write_vocab_file_with_blocklist

**Merger Tests:**
- test_merge_duplicates_single_entry
- test_merge_duplicates_confidence_weighted
- test_merge_duplicates_preserves_ip_flag

**Consolidator Tests:**
- test_consolidate_vocabularies_merges
- test_consolidate_vocabularies_creates_backup
- test_consolidate_vocabularies_change_summary

**IP Tests:**
- test_blocklist_case_insensitive
- test_blocklist_multi_word
- test_generate_review_queue

**CLI Tests (with mocked file operations):**
- test_output_command_help
- test_consolidate_command_help
- test_output_command_generates_vocab
- test_consolidate_command_shows_summary

Use pytest fixtures for temp directories. Mock file I/O where appropriate.
  </action>
  <verify>
pytest tests/test_output.py -v
  </verify>
  <done>
20+ tests pass covering models, writer, merger, consolidator, IP module, and CLI
  </done>
</task>

</tasks>

<verification>
Full end-to-end verification:
```bash
# Run all tests
pytest tests/test_output.py -v

# CLI smoke tests
corpora output --help
corpora consolidate --help

# Module import check
python -c "
from corpora.output import (
    VocabularyOutput, write_vocab_file, consolidate_vocabularies,
    CorporaManifest, merge_duplicates, ConsolidationSummary
)
from corpora.ip import (
    IPBlocklist, detect_ip, flag_terms,
    generate_review_queue, ReviewQueue
)
print('All Phase 3 modules import successfully')
"
```
</verification>

<success_criteria>
- generate_review_queue creates flagged.json with review-ready structure
- 'corpora output' converts extract JSON to .vocab.json
- 'corpora consolidate' merges vocab files with change summary
- Incremental mode skips unchanged files (manifest-based)
- --force reprocesses all files
- --remove-orphans removes terms from deleted sources
- All tests pass
- CLI help shows clear usage
</success_criteria>

<output>
After completion, create `.planning/phases/03-output-ip-review/03-04-SUMMARY.md`
</output>
